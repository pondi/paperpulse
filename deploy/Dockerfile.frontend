FROM alpine:3.22 AS php_build

WORKDIR /var/www/html

# Base PHP runtime with build tooling for Composer
# Includes ImageMagick for Composer platform requirements (spatie/pdf-to-image dependency)
RUN echo "GMT" > /etc/timezone \
    && apk add --no-cache \
        bash \
        curl \
        php84 \
        php84-cli \
        php84-common \
        php84-pdo \
        php84-pdo_pgsql \
        php84-opcache \
        php84-zip \
        php84-curl \
        php84-openssl \
        php84-mbstring \
        php84-tokenizer \
        php84-fileinfo \
        php84-phar \
        php84-xml \
        php84-dom \
        php84-simplexml \
        php84-xmlreader \
        php84-xmlwriter \
        php84-json \
        php84-ctype \
        php84-session \
        php84-iconv \
        php84-pecl-redis \
        php84-intl \
        php84-pcntl \
        php84-posix \
        php84-pecl-imagick \
        imagemagick \
        ghostscript

# Install Composer for dependency resolution
RUN ln -sf /usr/bin/php84 /usr/bin/php \
    && curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/bin/ --filename=composer

# Install PHP dependencies without dev and without running Composer scripts
COPY composer.json composer.lock ./
RUN composer install --no-dev --no-interaction --prefer-dist --optimize-autoloader --no-progress --no-scripts \
    && composer check-platform-reqs --no-dev --no-interaction

# Copy the full application source
COPY . .

# Regenerate optimized autoload files with actual application classes
RUN composer dump-autoload --optimize --no-dev


FROM node:22-alpine3.22 AS assets

WORKDIR /app

COPY package*.json ./
RUN npm ci --no-progress

# Bring in PHP vendor deps needed for Ziggy during asset build
COPY --from=php_build /var/www/html/vendor ./vendor
COPY . .

# Set build-time environment variable for Vite
ARG VITE_APP_NAME=PaperPulse
ENV VITE_APP_NAME=${VITE_APP_NAME}

# Build production assets
RUN npm run build


FROM alpine:3.22

WORKDIR /var/www/html

# Runtime dependencies only (no nodejs, npm, ImageMagick - not needed for serving)
RUN echo "GMT" > /etc/timezone \
    && apk add --no-cache \
        nginx \
        supervisor \
        bash \
        curl \
        php84 \
        php84-cli \
        php84-common \
        php84-fpm \
        php84-pdo \
        php84-pdo_pgsql \
        php84-opcache \
        php84-curl \
        php84-openssl \
        php84-mbstring \
        php84-tokenizer \
        php84-fileinfo \
        php84-phar \
        php84-xml \
        php84-dom \
        php84-simplexml \
        php84-xmlreader \
        php84-xmlwriter \
        php84-json \
        php84-ctype \
        php84-session \
        php84-iconv \
        php84-pecl-redis \
        php84-intl

# Setup PHP symlink and required directories
RUN ln -sf /usr/bin/php84 /usr/bin/php \
    && mkdir -p /var/lib/nginx/logs /var/lib/nginx/tmp/client_body /var/log/nginx /var/log/php84 /var/run/nginx \
    && chown -R nobody:nobody /var/lib/nginx /var/log/nginx /var/log/php84 /var/run/nginx

# Copy application code and dependencies
COPY --from=php_build /var/www/html /var/www/html

# Copy built assets
COPY --from=assets /app/public/build /var/www/html/public/build

# Configure supervisor, nginx, and PHP-FPM
RUN mkdir -p /etc/supervisor.d/ /etc/php84/php-fpm.d/
COPY deploy/frontend/supervisord.ini /etc/supervisor.d/supervisord.ini
COPY deploy/frontend/nginx.conf /etc/nginx/nginx.conf
COPY deploy/frontend/nginx-laravel.conf /etc/nginx/conf.d/default.conf
COPY deploy/frontend/php-fpm-www.conf /etc/php84/php-fpm.d/zz-docker.conf

COPY deploy/frontend/entrypoint.sh /usr/local/bin/entrypoint.sh

# Cleanup and set permissions in a single layer
RUN chmod +x /usr/local/bin/entrypoint.sh \
    && chmod 644 /etc/php84/php-fpm.d/zz-docker.conf \
    && mkdir -p /var/www/html/storage /var/www/html/bootstrap/cache \
    && rm -rf \
        /var/www/html/deploy \
        /var/www/html/docs \
        /var/www/html/tests \
        /var/www/html/node_modules \
        /var/www/html/.git \
        /var/www/html/.github \
        /var/www/html/package*.json \
        /var/www/html/vite.config.js \
        /var/www/html/tailwind.config.js \
        /var/www/html/postcss.config.js \
        /var/www/html/phpunit.xml \
        /var/www/html/phpstan.neon \
        /var/www/html/pint.json \
        /var/www/html/.editorconfig \
        /var/www/html/.env.example \
        /var/www/html/README.md \
        /var/www/html/CLAUDE.md \
        /var/www/html/vendor/meilisearch/meilisearch-php/Dockerfile \
        /var/www/html/bootstrap/cache/*.php \
        /var/cache/apk/* \
    && chown -R nobody:nobody /var/www/html

USER nobody

HEALTHCHECK --interval=30s --timeout=5s --retries=3 CMD curl -fsS http://127.0.0.1:8080/ || exit 1

ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]
